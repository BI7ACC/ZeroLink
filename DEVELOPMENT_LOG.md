# ZeroLink - 开发日志

本文档记录了 `ZeroLink` 项目从早期原型到当前版本的主要开发历程、技术决策和架构演进。

## [v0.1.1-alpha.1+2025.12.07-build04] "Bedrock" - 核心架构重构

**目标**: 将 v0.1 的单文件原型重构为一个健壮、模块化、可扩展的应用程序，为实现群聊等高级功能铺平道路。

### 1. 项目结构模块化

- **决策**: 放弃原有的扁平化单文件结构，引入分层设计。
- **实施**:
    - 创建了三个顶级目录：
        - `/core`: 存放与业务无关的核心组件（加密、存储、网络协议等）。
        - `/client`: 存放客户端UI和业务逻辑。
        - `/server`: 存放引导服务器的实现。
    - 使用 `CMakeLists.txt` 管理新的项目结构，实现了模块化编译。

### 2. UI/UX 彻底重构

- **目标**: 解决原型UI的交互混乱问题，设计一个现代化的TUI。
- **实施**:
    - **引入标签页导航**:
        - 设计了“好友”、“添加好友”、“设置”、“退出”四个核心标签页。
        - 用户可通过 `←` / `→` 方向键进行导航。
    - **分离导航与输入**:
        - **主界面**现在是纯粹的“导航模式”，只响应方向键和回车，解决了在主页打字导致程序卡死的Bug。
        - **聊天/表单界面**进入“文本输入模式”，提供流畅的打字体验。
    - **按需显示UI元素**:
        - 主界面不显示输入框，以提供更简洁的导航视图。
        - 输入框只在需要文本输入的上下文中创建和显示。
    - **独立的系统日志区**:
        - 在主界面顶部创建了一个固定的日志窗口，用于显示网络状态和系统信息，不再与操作区域混杂。

### 3. 并发模型与稳定性修复

- **目标**: 解决原型阶段存在的严重并发问题，如UI错乱、死锁和资源泄漏。
- **实施**:
    - **UI线程安全**:
        - **决策**: 严格遵守“所有UI绘制和刷新操作必须在单一主线程中执行”的原则。
        - **重构**: 移除了在后台线程中直接调用 `ncurses` 函数的错误逻辑。引入了一个线程安全的日志队列 (`log_queue`)，后台线程只负责将日志消息入队，UI主线程负责从队列中取出并绘制。
    - **死锁修复**:
        - **决策**: 引入更细粒度的锁，并打破锁的嵌套调用。
        - **实施**:
            - 新增了 `db_mutex`，所有数据库操作现在都受其保护。
            - 重构了 `request_chat_sync` 和 `add_peer` 等函数，确保在调用其他模块的函数（如 `log_msg`）之前，先释放自身持有的锁（如 `peers_mutex`）。
    - **资源泄漏修复**:
        - **定位**: 发现 `receive_from_peer` 线程在结束后未调用 `remove_peer`，导致连接句柄和内存泄漏。
        - **修复**: 恢复了对 `remove_peer` 的调用，确保断开的P2P连接能被正确清理。

### 4. 功能完善

- **设置页面**: 实现了“设置”标签页，现在可以显示用户的公钥、P2P端口和在线好友数。
- **指令系统**: 在聊天界面，以 `/` 开头的输入被视为指令。已实现 `/back` 和 `/help`。

### 当前状态

项目已达到一个相对稳定的里程碑。核心架构已经稳固，主要的功能Bug和并发问题已得到解决。代码的可读性和可维护性大幅提升。

### 后续计划

下一个重要的开发目标是 **实现群聊功能**。我们将基于“群聊是特殊联系人”的设计思想，逐步开发群组管理、密钥分发和消息广播等功能。
